<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Kyky - Connexion & Inscription</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2196f3">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, collection, doc, setDoc, query, where, getDocs, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDFfUnu076ChN_Js0QYmaABdJJMOQbGv1Q",
      authDomain: "kyky-4b748.firebaseapp.com",
      projectId: "kyky-4b748",
      storageBucket: "kyky-4b748.firebasestorage.app",
      messagingSenderId: "980205708455",
      appId: "1:980205708455:web:b9125afa8028f65b042782",
      measurementId: "G-HDMXRP2FP0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Connexion
    async function login(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const msgBox = document.getElementById("loginMessage");

      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;

        // VÃ©rifie si banni
        const userDoc = await getDocs(query(collection(db, "users"), where("__name__", "==", uid)));
        if (!userDoc.empty && userDoc.docs[0].data().banned) {
          msgBox.innerText = "â›” Vous avez Ã©tÃ© banni.";
          msgBox.className = "text-red-400 mt-2 text-sm";
          return;
        }

        msgBox.innerText = "âœ… Connexion rÃ©ussie !";
        msgBox.className = "text-green-400 mt-2 text-sm";
        setTimeout(() => {
          window.location.href = "home.html";
        }, 1200);
      } catch (err) {
        msgBox.innerText = "âŒ " + err.message;
        msgBox.className = "text-red-400 mt-2 text-sm";
      }
    }

    // Inscription
    async function signup(e) {
      e.preventDefault();
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const pseudo = document.getElementById("signupPseudo").value.trim();
      const msgBox = document.getElementById("signupMessage");

      try {
        // VÃ©rifie si pseudo dÃ©jÃ  pris
        const q = query(collection(db, "users"), where("pseudoLower", "==", pseudo.toLowerCase()));
        const snap = await getDocs(q);
        if (!snap.empty) {
          msgBox.innerText = "âš ï¸ Ce pseudo est dÃ©jÃ  utilisÃ©";
          msgBox.className = "text-yellow-400 mt-2 text-sm";
          return;
        }

        // CrÃ©e compte Auth
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;

        // Sauvegarde profil Firestore
        await setDoc(doc(db, "users", uid), {
          email: email,
          pseudo: pseudo,
          pseudoLower: pseudo.toLowerCase(),
          banned: false,
          createdAt: new Date()
        });

        msgBox.innerText = "âœ… Inscription rÃ©ussie ! Vous pouvez vous connecter.";
        msgBox.className = "text-green-400 mt-2 text-sm";
        setTimeout(() => toggleForms("login"), 2000);
      } catch (err) {
        msgBox.innerText = "âŒ " + err.message;
        msgBox.className = "text-red-400 mt-2 text-sm";
      }
    }

    // Bascule entre login/signup
    function toggleForms(mode) {
      const loginBox = document.getElementById("loginBox");
      const signupBox = document.getElementById("signupBox");
      if (mode === "signup") {
        loginBox.classList.add("hidden");
        signupBox.classList.remove("hidden");
      } else {
        signupBox.classList.add("hidden");
        loginBox.classList.remove("hidden");
      }
    }

    // Compteur utilisateurs en temps rÃ©el
    function listenUsersCount() {
      const usersCol = collection(db, "users");
      onSnapshot(usersCol, (snapshot) => {
        document.getElementById("usersCount").innerText = snapshot.size;
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginForm").addEventListener("submit", login);
      document.getElementById("signupForm").addEventListener("submit", signup);
      document.querySelectorAll("[data-toggle]").forEach(btn =>
        btn.addEventListener("click", () => toggleForms(btn.dataset.toggle))
      );
      listenUsersCount();
    });
  </script>
</head>
<body class="h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600">
  
  <div class="backdrop-blur-xl bg-white/10 border border-white/20 shadow-2xl rounded-2xl p-10 w-full max-w-md">
    <h2 class="text-3xl font-bold text-white text-center mb-2">ðŸš€ Kyky</h2>
    <p class="text-gray-200 text-center mb-6">ðŸ‘¥ <span id="usersCount">0</span> inscrits</p>
    
    <!-- Connexion -->
    <div id="loginBox">
      <h3 class="text-xl text-white text-center mb-4">Connexion</h3>
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm text-gray-200">Email</label>
          <input type="email" id="loginEmail" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white">
        </div>
        <div>
          <label class="block text-sm text-gray-200">Mot de passe</label>
          <input type="password" id="loginPassword" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white">
        </div>
        <div id="loginMessage"></div>
        <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold">
          Se connecter
        </button>
      </form>
      <p class="text-gray-300 text-center text-sm mt-6">
        Pas encore inscrit ?
        <button data-toggle="signup" class="text-pink-400 hover:underline">CrÃ©er un compte</button>
      </p>
    </div>

    <!-- Inscription -->
    <div id="signupBox" class="hidden">
      <h3 class="text-xl text-white text-center mb-4">Inscription</h3>
      <form id="signupForm" class="space-y-5">
        <div>
          <label class="block text-sm text-gray-200">Pseudo</label>
          <input type="text" id="signupPseudo" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white">
        </div>
        <div>
          <label class="block text-sm text-gray-200">Email</label>
          <input type="email" id="signupEmail" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white">
        </div>
        <div>
          <label class="block text-sm text-gray-200">Mot de passe</label>
          <input type="password" id="signupPassword" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white">
        </div>
        <div id="signupMessage"></div>
        <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-green-500 to-blue-600 text-white font-semibold">
          S'inscrire
        </button>
      </form>
      <p class="text-gray-300 text-center text-sm mt-6">
        DÃ©jÃ  inscrit ?
        <button data-toggle="login" class="text-pink-400 hover:underline">Se connecter</button>
      </p>
    </div>
  </div>
  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js")
    .then(() => console.log("Service Worker enregistrÃ©"))
    .catch((err) => console.log("Erreur SW :", err));
}
</script>

</body>
</html>
