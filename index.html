<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Kyky - Connexion & Inscription</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDFfUnu076ChN_Js0QYmaABdJJMOQbGv1Q",
      authDomain: "kyky-4b748.firebaseapp.com",
      projectId: "kyky-4b748",
      storageBucket: "kyky-4b748.firebasestorage.app",
      messagingSenderId: "980205708455",
      appId: "1:980205708455:web:b9125afa8028f65b042782",
      measurementId: "G-HDMXRP2FP0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Connexion
    async function login(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const q = query(
        collection(db, "users"),
        where("email", "==", email),
        where("password", "==", password)
      );
      const querySnapshot = await getDocs(q);

      const msgBox = document.getElementById("loginMessage");

      if (!querySnapshot.empty) {
        msgBox.innerText = "âœ… Connexion rÃ©ussie !";
        msgBox.className = "text-green-400 mt-2 text-sm";
        setTimeout(() => {
          window.location.href = "home.html";
        }, 1200);
      } else {
        msgBox.innerText = "âŒ Email ou mot de passe incorrect";
        msgBox.className = "text-red-400 mt-2 text-sm";
      }
    }

    // Inscription
    async function signup(e) {
      e.preventDefault();
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;

      const msgBox = document.getElementById("signupMessage");

      try {
        // VÃ©rifie si dÃ©jÃ  inscrit
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          msgBox.innerText = "âš ï¸ Cet email est dÃ©jÃ  utilisÃ©";
          msgBox.className = "text-yellow-400 mt-2 text-sm";
          return;
        }

        await addDoc(collection(db, "users"), {
          email: email,
          password: password
        });

        msgBox.innerText = "âœ… Inscription rÃ©ussie ! Vous pouvez vous connecter.";
        msgBox.className = "text-green-400 mt-2 text-sm";

        // Bascule auto vers connexion aprÃ¨s 2s
        setTimeout(() => toggleForms("login"), 2000);

      } catch (err) {
        msgBox.innerText = "âŒ Erreur: " + err.message;
        msgBox.className = "text-red-400 mt-2 text-sm";
      }
    }

    // Bascule entre login / signup
    function toggleForms(mode) {
      const loginBox = document.getElementById("loginBox");
      const signupBox = document.getElementById("signupBox");
      if (mode === "signup") {
        loginBox.classList.add("hidden");
        signupBox.classList.remove("hidden");
      } else {
        signupBox.classList.add("hidden");
        loginBox.classList.remove("hidden");
      }
    }

    // Compteur d'inscrits en temps rÃ©el
    function listenUsersCount() {
      const usersCol = collection(db, "users");
      onSnapshot(usersCol, (snapshot) => {
        const count = snapshot.size;
        document.getElementById("usersCount").innerText = count;
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginForm").addEventListener("submit", login);
      document.getElementById("signupForm").addEventListener("submit", signup);
      document.querySelectorAll("[data-toggle]").forEach(btn =>
        btn.addEventListener("click", () => toggleForms(btn.dataset.toggle))
      );

      listenUsersCount(); // dÃ©marre le compteur
    });
  </script>
</head>
<body class="h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600">
  
  <div class="backdrop-blur-xl bg-white/10 border border-white/20 shadow-2xl rounded-2xl p-10 w-full max-w-md">
    <h2 class="text-3xl font-bold text-white text-center mb-2">ðŸš€ Kyky</h2>
    <p class="text-gray-200 text-center mb-6">ðŸ‘¥ <span id="usersCount">0</span> inscrits</p>
    
    <!-- Formulaire de Connexion -->
    <div id="loginBox">
      <h3 class="text-xl text-white text-center mb-4">Connexion</h3>
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm text-gray-200">Email</label>
          <input type="email" id="loginEmail" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white placeholder-gray-300 focus:ring-2 focus:ring-pink-400">
        </div>
        <div>
          <label class="block text-sm text-gray-200">Mot de passe</label>
          <input type="password" id="loginPassword" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white placeholder-gray-300 focus:ring-2 focus:ring-pink-400">
        </div>
        <div id="loginMessage"></div>
        <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold shadow-lg hover:scale-105 transform transition duration-300">
          Se connecter
        </button>
      </form>
      <p class="text-gray-300 text-center text-sm mt-6">
        Pas encore inscrit ?
        <button data-toggle="signup" class="text-pink-400 hover:underline">CrÃ©er un compte</button>
      </p>
    </div>

    <!-- Formulaire d'Inscription -->
    <div id="signupBox" class="hidden">
      <h3 class="text-xl text-white text-center mb-4">Inscription</h3>
      <form id="signupForm" class="space-y-5">
        <div>
          <label class="block text-sm text-gray-200">Email</label>
          <input type="email" id="signupEmail" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white placeholder-gray-300 focus:ring-2 focus:ring-pink-400">
        </div>
        <div>
          <label class="block text-sm text-gray-200">Mot de passe</label>
          <input type="password" id="signupPassword" required class="mt-1 w-full px-4 py-2 rounded-xl bg-white/20 text-white placeholder-gray-300 focus:ring-2 focus:ring-pink-400">
        </div>
        <div id="signupMessage"></div>
        <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-green-500 to-blue-600 text-white font-semibold shadow-lg hover:scale-105 transform transition duration-300">
          S'inscrire
        </button>
      </form>
      <p class="text-gray-300 text-center text-sm mt-6">
        DÃ©jÃ  inscrit ?
        <button data-toggle="login" class="text-pink-400 hover:underline">Se connecter</button>
      </p>
    </div>
  </div>

</body>
</html>
