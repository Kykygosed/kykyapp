<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Kyky — Mini Twitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getDatabase, ref, set, get, push, update, onValue, serverTimestamp, remove
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFfUnu076ChN_Js0QYmaABdJJMOQbGv1Q",
  authDomain: "kyky-4b748.firebaseapp.com",
  databaseURL: "https://kyky-4b748-default-rtdb.firebaseio.com/",
  projectId: "kyky-4b748",
  storageBucket: "kyky-4b748.appspot.com",
  messagingSenderId: "980205708455",
  appId: "1:980205708455:web:b9125afa8028f65b042782",
  measurementId: "G-HDMXRP2FP0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const uidKey = "kyky_uid";
const nameKey = "kyky_name";
let current = null;

function uuid() {
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
}

function initials(name) {
  return name.split(/[^a-zA-Z0-9]+/).filter(Boolean).slice(0,2).map(s=>s[0]).join("").toUpperCase().slice(0,2) || "U";
}

function timeAgo(ts) {
  const d = ts instanceof Date ? ts : new Date(ts);
  const diff = (Date.now() - d.getTime())/1000;
  if (diff < 60) return "now";
  if (diff < 3600) return Math.floor(diff/60)+"m";
  if (diff < 86400) return Math.floor(diff/3600)+"h";
  return d.toLocaleDateString();
}

function el(strings,...vals){ return strings.map((s,i)=>s+(vals[i]??"")).join(""); }

function adminBadge(isAdmin) {
  return isAdmin ? '<span class="ml-2 px-2 py-0.5 text-xs font-bold text-white bg-blue-500 rounded">ADMIN</span>' : '';
}

/* Identité utilisateur */
async function ensureIdentity() {
  let uid = localStorage.getItem(uidKey);
  let displayName = localStorage.getItem(nameKey);

  if (!uid) {
    uid = uuid();
    localStorage.setItem(uidKey, uid);
  }

  if (!displayName) {
    displayName = "user_" + uid.slice(0,5);
    localStorage.setItem(nameKey, displayName);
  }

  const userRef = ref(db, "users/" + uid);
  const snap = await get(userRef);

  if (!snap.exists()) {
    await set(userRef, {
      uid,
      username: displayName,
      usernameLower: displayName.toLowerCase(),
      followersCount: 0,
      postsCount: 0,
      createdAt: serverTimestamp(),
      lastActiveAt: serverTimestamp(),
      banned: false,
      admin: false
    });
  } else {
    await update(userRef, {
      username: displayName,
      usernameLower: displayName.toLowerCase(),
      lastActiveAt: serverTimestamp()
    });
  }

  document.getElementById("meName").textContent = displayName;
  document.getElementById("meHandle").textContent = "@"+displayName.toLowerCase();
  document.getElementById("avatarMe").textContent = initials(displayName);

  current = { uid, displayName, banned: snap.val()?.banned || false, admin: snap.val()?.admin || false };

  onValue(userRef, (snap)=>{
    const banned = snap.val()?.banned || false;
    current.banned = banned;
    if (banned) showBannedMessage();
  });

  return current;
}

/* Bannissement */
function showBannedMessage() {
  const composeSection = document.querySelector(".bg-white.p-4.rounded-xl.shadow");
  composeSection.innerHTML = `
    <div class="flex items-center gap-4 p-4 rounded-xl" style="background: linear-gradient(to right, #ff4d4d, #990000); color: white;">
      <img src="alert.png" class="w-12 h-12"/>
      <div>
        <div class="font-bold text-lg">Vous avez été banni par un administrateur.</div>
        <div class="text-sm">Vous ne pouvez plus continuer toute activité.</div>
      </div>
    </div>
  `;
}

/* Compose Tweet */
function wireCompose() {
  const ta = document.getElementById("tweetInput");
  const btn = document.getElementById("tweetBtn");

  ta.addEventListener("input", () => {
    if (current.banned) return;
    const len = ta.value.trim().length;
    document.getElementById("charLeft").textContent = 280-len;
    btn.disabled = len === 0 || len > 280;
  });

  btn.addEventListener("click", async () => {
    if (current.banned) return;
    const text = ta.value.trim();
    if (!text || text.length > 280) return;

    const postsRef = ref(db, "posts");
    const newPostRef = push(postsRef);
    const post = {
      id: newPostRef.key,
      authorId: current.uid,
      authorName: current.displayName,
      authorHandle: "@"+current.displayName.toLowerCase(),
      text,
      createdAt: serverTimestamp(),
      likeCount: 0,
      commentCount: 0,
      admin: current.admin
    };
    await set(newPostRef, post);

    const userRef = ref(db,"users/"+current.uid);
    const userSnap = await get(userRef);
    const postsCount = (userSnap.val()?.postsCount || 0) + 1;
    await update(userRef, { postsCount, lastActiveAt: serverTimestamp() });

    ta.value = "";
    document.getElementById("charLeft").textContent = 280;
    btn.disabled = true;
  });
}


function listenLatestPosts() {
  const postsRef = ref(db, "posts");
  onValue(postsRef, async (snap) => {
    const wrap = document.getElementById("feed");
    wrap.innerHTML = "";

    const posts = snap.val();
    if (!posts) return;

    // Récupérer la liste des blocs pour l'utilisateur courant
    const blocksSnap = await get(ref(db, "blocks"));
    const blocks = blocksSnap.val() || {};

    // Filtrer les posts bloqués
    const visiblePosts = Object.values(posts)
      .filter(p => !blocks[`${current.uid}_${p.authorId}`])
      .sort((a,b)=>b.createdAt - a.createdAt)
      .slice(0,25);

    // Affichage des posts visibles
    visiblePosts.forEach(p => {
      renderPost(p).then(html => {
        wrap.insertAdjacentHTML("beforeend", html);
        wirePostActions(p);
        listenCountsLive(p.id);
      });
    });
  });
}


async function renderPost(p) {
  const userSnap = await get(ref(db,"users/"+p.authorId));
  const av = initials(p.authorName||"User");
  const canDelete = p.authorId === current.uid;

  const likeSnap = await get(ref(db, `postLikes/${p.id}/${current.uid}`));
  const liked = likeSnap.exists();
  const likeIcon = liked ? "like.png" : "unlike.png";

  const isCurrentAdmin = current?.admin; // admin connecté

  return el`
    <article id="post_${p.id}" class="bg-white p-4 rounded-xl shadow border border-gray-100 relative">
      <div class="flex items-start space-x-4">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-semibold text-gray-700">${av}</div>
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="font-semibold">${p.authorName||"User"}</span>
              ${adminBadge(userSnap.val()?.admin)}
              <span class="text-gray-500 text-sm">${p.authorHandle||""}</span>
              <span class="text-gray-400 text-sm">· ${timeAgo(p.createdAt)}</span>
            </div>
            <div class="relative">
              <button data-act="menu" class="px-2">⋮</button>
              <div id="menu_${p.id}" class="absolute right-0 mt-1 w-44 bg-white border rounded shadow-lg hidden z-10">
                <button data-act="report" data-id="${p.id}" class="flex items-center gap-2 w-full px-2 py-1 hover:bg-gray-100">
                  <img src="report.png" class="w-4 h-4"/> Signaler
                </button>
                <button data-act="block" data-author="${p.authorId}" class="flex items-center gap-2 w-full px-2 py-1 hover:bg-gray-100">
                  <img src="block.png" class="w-4 h-4"/> Bloquer l'utilisateur
                </button>
                ${isCurrentAdmin ? `
                  <button data-act="adminDelete" data-id="${p.id}" class="flex items-center gap-2 w-full px-2 py-1 text-red-600 hover:bg-gray-100">
                    <img src="delete.png" class="w-4 h-4"/> Supprimer
                  </button>
                  <button data-act="ban" data-author="${p.authorId}" class="flex items-center gap-2 w-full px-2 py-1 text-red-600 hover:bg-gray-100">
                    <img src="ban.png" class="w-4 h-4"/> Bannir
                  </button>
                ` : ""}
              </div>
            </div>
          </div>

          <p class="mt-1">${(p.text||"").replace(/</g,"&lt;")}</p>

          <div class="flex items-center gap-6 mt-3 text-gray-500 text-sm">
            <button data-act="comment" data-id="${p.id}"><img src="comments.png" class="w-5 h-5"/> <span id="c_${p.id}">${p.commentCount||0}</span></button>
            <button data-act="like" data-id="${p.id}"><img src="${likeIcon}" class="w-5 h-5"/> <span id="l_${p.id}">${p.likeCount||0}</span></button>
            <button data-act="reply" data-id="${p.id}"><img src="reply.png" class="w-5 h-5"/></button>
            ${canDelete && !isCurrentAdmin ? `<button data-act="delete" data-id="${p.id}" class="text-red-500 font-bold ml-2">Supprimer</button>` : ""}
          </div>

          <div id="comments_${p.id}" class="mt-3 space-y-3 hidden"></div>
          <div id="composer_${p.id}" class="mt-3 hidden">
            <textarea id="input_${p.id}" rows="2" class="w-full border rounded-lg p-2" placeholder="Écrire un commentaire…"></textarea>
            <div class="flex justify-end mt-2">
              <button data-act="sendComment" data-id="${p.id}" class="px-3 py-1 rounded-lg bg-blue-500 text-white">Publier</button>
            </div>
          </div>
        </div>
      </div>
    </article>
  `;
}

  
function wirePostActions(p) {
  if (current.banned) return;
  const root = document.getElementById(`post_${p.id}`);

  root.querySelector('[data-act="comment"]').addEventListener("click", () => toggleComments(p.id));
  root.querySelector('[data-act="reply"]').addEventListener("click", () => toggleComposer(p.id, true));
  root.querySelector('[data-act="like"]').addEventListener("click", () => toggleLike(p.id));
  root.querySelector('[data-act="sendComment"]').addEventListener("click", () => sendComment(p.id));

  // Menu contextuel
  const menuBtn = root.querySelector('[data-act="menu"]');
  const menuDiv = root.querySelector(`#menu_${p.id}`);
  menuBtn.addEventListener("click", () => menuDiv.classList.toggle("hidden"));

  // Signaler
  const reportBtn = root.querySelector('[data-act="report"]');
  reportBtn.addEventListener("click", async () => {
    await update(ref(db,"posts/"+p.id), { reported: true });
    menuDiv.classList.add("hidden");
  });

  // Bloquer l'utilisateur
  const blockBtn = root.querySelector('[data-act="block"]');
  blockBtn.addEventListener("click", async () => {
    const blockedRef = ref(db, `blocks/${current.uid}_${p.authorId}`);
    await set(blockedRef, { blocker: current.uid, blocked: p.authorId });
    menuDiv.classList.add("hidden");
  });

  // Admin : supprimer
  const adminDelete = root.querySelector('[data-act="adminDelete"]');
  if (adminDelete) {
    adminDelete.addEventListener("click", async () => {
      if (!confirm("Supprimer ce post ?")) return;
      await remove(ref(db, "posts/" + p.id));
      await remove(ref(db, "postComments/" + p.id));
    });
  }

  // Admin : bannir
  const banBtn = root.querySelector('[data-act="ban"]');
  if (banBtn) {
    banBtn.addEventListener("click", async () => {
      if (!confirm("Bannir cet utilisateur ?")) return;
      await update(ref(db,"users/"+p.authorId), { banned: true });
    });
  }

  // Supprimer pour l’auteur du post
  const deleteBtn = root.querySelector('[data-act="delete"]');
  if (deleteBtn) {
    deleteBtn.addEventListener("click", async () => {
      if (!confirm("Supprimer ce post ?")) return;
      await remove(ref(db, "posts/" + p.id));
      await remove(ref(db, "postComments/" + p.id));
    });
  }
}



function toggleComposer(postId, show){
  const box = document.getElementById(`composer_${postId}`);
  if (show===true) box.classList.remove("hidden");
  else box.classList.toggle("hidden");
}

function toggleComments(postId){
  const list = document.getElementById(`comments_${postId}`);
  list.classList.toggle("hidden");
  if (!list.dataset.loaded) listenComments(postId);
}

async function toggleLike(postId){
  if (current.banned) return;
  const uid = current.uid;
  const likeRef = ref(db, `postLikes/${postId}/${uid}`);
  const snap = await get(likeRef);
  const postRef = ref(db, `posts/${postId}`);
  const postSnap = await get(postRef);
  const post = postSnap.val();
  if (!post) return;

  if (snap.exists()) {
    await remove(likeRef);
    await update(postRef, { likeCount: (post.likeCount||0) - 1 });
  } else {
    await set(likeRef, { uid, createdAt: serverTimestamp() });
    await update(postRef, { likeCount: (post.likeCount||0) + 1 });
  }
}

async function sendComment(postId){
  if (current.banned) return;
  const input = document.getElementById(`input_${postId}`);
  const text = input.value.trim();
  if (!text) return;

  const commentRef = ref(db, `postComments/${postId}`);
  const newCommentRef = push(commentRef);
  await set(newCommentRef, {
    authorId: current.uid,
    authorName: current.displayName,
    text,
    createdAt: serverTimestamp(),
    replyTo: null,
    admin: current.admin
  });

  const postRef = ref(db, `posts/${postId}`);
  const postSnap = await get(postRef);
  const post = postSnap.val();
  await update(postRef, { commentCount: (post.commentCount||0) + 1 });

  input.value = "";
  toggleComposer(postId,false);
}

function listenComments(postId){
  const list = document.getElementById(`comments_${postId}`);
  const commentsRef = ref(db, `postComments/${postId}`);
  onValue(commentsRef, snap=>{
    list.innerHTML = "";
    const comments = snap.val();
    if (!comments) return;
    Object.values(comments)
      .sort((a,b)=>a.createdAt - b.createdAt)
      .forEach(d=>{
        list.insertAdjacentHTML("beforeend", el`
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-700">${initials(d.authorName||"U")}</div>
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-2 flex-1">
              <div class="text-sm"><span class="font-semibold">${d.authorName}</span> ${adminBadge(d.admin)} <span class="text-gray-400">· ${timeAgo(d.createdAt)}</span></div>
              <div class="text-sm">${(d.text||"").replace(/</g,"&lt;")}</div>
            </div>
          </div>
        `);
      });
    list.dataset.loaded = "1";
  });
}

function listenCountsLive(postId){
  const postRef = ref(db, `posts/${postId}`);
  onValue(postRef, snap=>{
    const d = snap.val();
    if (!d) return;
    const l = document.getElementById(`l_${postId}`); if (l) l.textContent = d.likeCount||0;
    const c = document.getElementById(`c_${postId}`); if (c) c.textContent = d.commentCount||0;
  });
}

function listenTopUsers() {
  const box = document.getElementById("whoToFollow");
  const me = current.uid;

  async function refresh() {
    const snap = await get(ref(db, "users"));
    const users = snap.val();
    if (!users) return;

    box.innerHTML = ""; // vide avant chaque rendu

    Object.values(users)
      .sort((a,b)=>b.postsCount - a.postsCount)
      .slice(0,5)
      .forEach(u=>{
        if (u.uid === me) return;
        renderUserRowRTDB(u, box);
      });
  }

  refresh(); // première exécution immédiate
  setInterval(refresh, 5000); // puis toutes les 5 secondes
}




async function renderUserRowRTDB(u, container){
  const me = current.uid;
  const isFollowing = await isFollowingUser(me,u.uid);
  container.insertAdjacentHTML("beforeend", el`
    <div id="u_${u.uid}" class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-gray-300 flex items-center justify-center text-xs font-semibold text-gray-700">${initials(u.username)}</div>
        <div>
          <div class="font-semibold text-sm">${u.username}${adminBadge(u.admin)}</div>
          <div class="text-gray-500 text-xs">@${u.usernameLower}</div>
          <div class="text-gray-500 text-xs">${u.followersCount||0} followers · ${u.postsCount||0} posts</div>
        </div>
      </div>
      <button data-follow="${u.uid}" class="px-3 py-1 rounded-full text-sm ${isFollowing?'bg-gray-200':'bg-blue-500 text-white'}">
        ${isFollowing?'Unfollow':'Follow'}
      </button>
    </div>
  `);
  wireFollowBtn(u.uid);
}

function wireFollowBtn(userId){
  if (current.banned) return;
  const btn = document.querySelector(`[data-follow="${userId}"]`);
  btn.addEventListener("click", async ()=>{
    const me = current.uid;
    const relRef = ref(db,"follows/"+me+"_"+userId);
    const relSnap = await get(relRef);
    const userRef = ref(db,"users/"+userId);
    const userSnap = await get(userRef);
    const user = userSnap.val();

    if (relSnap.exists()){
      await remove(relRef);
      await update(userRef, { followersCount: (user.followersCount||1) - 1 });
      btn.classList.remove("bg-gray-200"); btn.classList.add("bg-blue-500","text-white");
      btn.textContent = "Follow";
    } else {
      await set(relRef, { followerId: me, followeeId: userId, createdAt: serverTimestamp() });
      await update(userRef, { followersCount: (user.followersCount||0) + 1 });
      btn.classList.remove("bg-blue-500","text-white"); btn.classList.add("bg-gray-200");
      btn.textContent = "Unfollow";
    }
  });
}

async function isFollowingUser(me, otherId){
  const snap = await get(ref(db,"follows/"+me+"_"+otherId));
  return snap.exists();
}

/* Change Pseudo */
document.addEventListener("click",(e)=>{
  if (e.target?.id === "changeName") {
    const asked = prompt("Nouveau pseudo :")?.trim();
    if (!asked) return;
    localStorage.setItem(nameKey, asked);
    ensureIdentity();
  }
});

/* DOMContentLoaded */
window.addEventListener("DOMContentLoaded", async () => {
  await ensureIdentity();
  if (!current.banned) wireCompose();
  listenLatestPosts();
  listenTopUsers();
});
</script>


</head>
<body class="bg-gray-100">
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-xl font-bold">- Kyky -</div>
      <div class="flex items-center gap-3">
        <div id="avatarMe" class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs font-semibold text-gray-700">ME</div>
        <div class="text-sm">
          <div id="meName" class="font-semibold">Me</div>
          <div id="meHandle" class="text-gray-500">@me</div>
        </div>
        <button id="changeName" class="ml-2 text-sm px-3 py-1 rounded-lg border">Changer</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 mt-6 flex gap-6">
    <!-- center / timeline -->
    <section class="w-full lg:w-2/3 space-y-6">
      <!-- compose -->
      <div class="bg-white p-4 rounded-xl shadow">
        <div class="flex gap-4">
          <div id="avatarMe2" class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-semibold text-gray-700">
            <script>document.currentScript.parentElement.textContent = (localStorage.getItem("kyky_name")||"U").slice(0,2).toUpperCase();</script>
          </div>
          <textarea id="tweetInput" rows="3" maxlength="280" class="w-full border rounded-lg p-3 focus:ring focus:ring-blue-200" placeholder="What's happening..."></textarea>
        </div>
        <div class="flex items-center justify-between mt-2">
          <div class="text-sm text-gray-500"><span id="charLeft">280</span></div>
          <button id="tweetBtn" disabled class="bg-blue-500 hover:bg-blue-600 disabled:opacity-40 text-white px-4 py-2 rounded-lg font-semibold">Tweet</button>
        </div>
      </div>

      <!-- feed -->
      <div id="feed" class="space-y-4"></div>
    </section>

    <!-- right / who to follow -->
    <aside class="hidden lg:block w-1/3">
      <div class="bg-white p-4 rounded-xl shadow">
        <h3 class="font-bold text-lg mb-4">Who to follow</h3>
        <div id="whoToFollow"></div>
      </div>
    </aside>
  </main>

  <footer class="max-w-7xl mx-auto px-4 py-8 text-sm text-gray-500">
    Built with Tailwind + Firestore (sans Auth pour démo)
  </footer>
</body>
</html>
