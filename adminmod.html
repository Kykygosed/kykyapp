<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Modération - Kyky</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, onValue, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFfUnu076ChN_Js0QYmaABdJJMOQbGv1Q",
  authDomain: "kyky-4b748.firebaseapp.com",
  databaseURL: "https://kyky-4b748-default-rtdb.firebaseio.com/",
  projectId: "kyky-4b748",
  storageBucket: "kyky-4b748.appspot.com",
  messagingSenderId: "980205708455",
  appId: "1:980205708455:web:b9125afa8028f65b042782",
  measurementId: "G-HDMXRP2FP0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Utilisateur courant (admin)
let current = { uid: "ADMIN_UID", admin: true }; // à remplacer par auth réelle

function el(strings,...vals){ return strings.map((s,i)=>s+(vals[i]??"")).join(""); }
function initials(name){ return name.split(/[^a-zA-Z0-9]+/).filter(Boolean).map(s=>s[0]).join("").toUpperCase().slice(0,2); }
function timeAgo(ts){ const d=new Date(ts); const diff=(Date.now()-d.getTime())/1000; if(diff<60)return"now"; if(diff<3600)return Math.floor(diff/60)+"m"; if(diff<86400)return Math.floor(diff/3600)+"h"; return d.toLocaleDateString(); }
function adminBadge(isAdmin){ return isAdmin?'<span class="ml-2 px-2 py-0.5 text-xs font-bold text-white bg-blue-500 rounded">ADMIN</span>':''; }

// Rendu d’un post avec conteneur pour commentaires
async function renderPost(p){
  const userSnap = await get(ref(db,"users/"+p.authorId));
  const av = initials(p.authorName||"User");
  const isCurrentAdmin = current?.admin;
  
  return el`
    <article id="post_${p.id}" class="bg-white p-4 rounded-xl shadow border border-gray-100 relative">
      <div class="flex items-start space-x-4">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-semibold text-gray-700">${av}</div>
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="font-semibold">${p.authorName||"User"}</span>
              ${adminBadge(userSnap.val()?.admin)}
              <span class="text-gray-500 text-sm">${p.authorHandle||""}</span>
              <span class="text-gray-400 text-sm">· ${timeAgo(p.createdAt)}</span>
            </div>
          </div>
          <p class="mt-1">${(p.text||"").replace(/</g,"&lt;")}</p>

          <div id="comments_${p.id}" class="mt-3 space-y-3 text-sm text-gray-700"></div>

          <div class="flex items-center gap-4 mt-3">
            ${isCurrentAdmin ? `
            <button data-act="adminDelete" data-id="${p.id}" class="px-2 py-1 bg-red-600 text-white rounded flex items-center gap-2">
              <img src="delete.png" class="w-4 h-4"/> Supprimer
            </button>
            <button data-act="ban" data-author="${p.authorId}" class="px-2 py-1 bg-red-600 text-white rounded flex items-center gap-2">
              <img src="ban.png" class="w-4 h-4"/> Bannir
            </button>` : ""}
          </div>
        </div>
      </div>
    </article>
  `;
}

// Écoute des commentaires pour un post
function listenComments(postId){
  const list = document.getElementById(`comments_${postId}`);
  if(!list) return;
  const commentsRef = ref(db, `postComments/${postId}`);
  onValue(commentsRef, snap=>{
    list.innerHTML = "";
    const comments = snap.val();
    if(!comments) return;
    Object.values(comments)
      .sort((a,b)=>a.createdAt - b.createdAt)
      .forEach(c=>{
        list.insertAdjacentHTML("beforeend", el`
          <div class="flex items-start gap-2">
            <div class="w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-700">${initials(c.authorName||"U")}</div>
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-2 flex-1">
              <div class="text-xs"><span class="font-semibold">${c.authorName}</span> ${adminBadge(c.admin)} · ${timeAgo(c.createdAt)}</div>
              <div>${(c.text||"").replace(/</g,"&lt;")}</div>
            </div>
          </div>
        `);
      });
  });
}

// Dans wirePostActions, appeler listenComments
function wirePostActions(p){
  const root = document.getElementById(`post_${p.id}`);
  if(!root) return;

  const adminDelete = root.querySelector('[data-act="adminDelete"]');
  if(adminDelete){
    adminDelete.addEventListener("click", async ()=>{
      if(!confirm("Supprimer ce post ?")) return;
      await remove(ref(db,"posts/"+p.id));
      await remove(ref(db,"postComments/"+p.id));
      root.remove();
    });
  }

  const banBtn = root.querySelector('[data-act="ban"]');
  if(banBtn){
    banBtn.addEventListener("click", async ()=>{
      if(!confirm("Bannir cet utilisateur ?")) return;
      await update(ref(db,"users/"+p.authorId),{ banned:true });
    });
  }

  // Écouter les commentaires pour ce post
  listenComments(p.id);
}

// Écoute des posts signalés
function listenReportedPosts(){
  const postsRef = ref(db,"posts");
  onValue(postsRef, async snap=>{
    const wrap = document.getElementById("reportedFeed");
    wrap.innerHTML = "";
    const posts = snap.val();
    if(!posts) return;

    Object.values(posts)
      .filter(p=>p.reported)
      .sort((a,b)=>b.createdAt - a.createdAt)
      .forEach(async p=>{
        const html = await renderPost(p);
        wrap.insertAdjacentHTML("beforeend",html);
        wirePostActions(p);
      });
  });
}

window.addEventListener("DOMContentLoaded", ()=>{
  listenReportedPosts();
});
</script>
</head>
<body class="bg-gray-100">
  <header class="bg-white border-b p-4">
    <h1 class="text-xl font-bold">Modération - Posts suspectés</h1>
  </header>
  <main class="max-w-3xl mx-auto p-4 space-y-4">
    <div id="reportedFeed" class="space-y-4"></div>
  </main>
</body>
</html>
